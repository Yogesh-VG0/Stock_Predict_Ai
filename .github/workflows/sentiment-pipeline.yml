name: Stock Sentiment Pipeline

on:
  schedule:
    # Run every 4 hours (at 00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)
    - cron: '0 */4 * * *'
  workflow_dispatch: # Manual trigger

env:
  MONGODB_URI: ${{ secrets.MONGODB_URI }}
  ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
  REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
  REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
  FINVIZ_API_KEY: ${{ secrets.FINVIZ_API_KEY }}

jobs:
  sentiment-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run sentiment pipeline
      run: |
        cd ml_backend
        python -c "
        import sys
        import os
        sys.path.append('.')
        
        from data.sentiment import SentimentAnalyzer
        from utils.mongodb import MongoDBClient
        from config.constants import TOP_100_TICKERS
        import logging
        
        logging.basicConfig(level=logging.INFO)
        logger = logging.getLogger(__name__)
        
        try:
            # Initialize services
            mongo_client = MongoDBClient(os.getenv('MONGODB_URI'))
            sentiment_analyzer = SentimentAnalyzer(mongo_client)
            
            # Process top tickers
            tickers = ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'AMZN', 'NVDA', 'META', 'NFLX', 'DIS', 'AMD']
            
            for ticker in tickers:
                logger.info(f'Processing sentiment for {ticker}')
                
                # Fetch and store sentiment from all sources
                try:
                    # News sentiment
                    news_sentiment = sentiment_analyzer.fetch_and_store_news_sentiment(ticker)
                    logger.info(f'{ticker} news sentiment: {news_sentiment}')
                    
                    # Reddit sentiment
                    reddit_sentiment = sentiment_analyzer.fetch_and_store_reddit_sentiment(ticker)
                    logger.info(f'{ticker} reddit sentiment: {reddit_sentiment}')
                    
                    # SEC filings sentiment
                    sec_sentiment = sentiment_analyzer.fetch_and_store_sec_sentiment(ticker)
                    logger.info(f'{ticker} SEC sentiment: {sec_sentiment}')
                    
                    # Seeking Alpha sentiment
                    sa_sentiment = sentiment_analyzer.fetch_and_store_seeking_alpha_sentiment(ticker)
                    logger.info(f'{ticker} Seeking Alpha sentiment: {sa_sentiment}')
                    
                except Exception as e:
                    logger.error(f'Error processing {ticker}: {e}')
                    continue
                    
            logger.info('Sentiment pipeline completed successfully!')
            
        except Exception as e:
            logger.error(f'Pipeline failed: {e}')
            sys.exit(1)
        "
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: sentiment-logs
        path: |
          *.log
          ml_backend/*.log
        retention-days: 7 