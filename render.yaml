services:
  # Main ML Backend API - 24/7 availability  
  - type: web
    name: stock-predictor-ml-api
    env: python
    plan: standard  # Need sufficient memory for ML models
    buildCommand: |
      # Install system dependencies
      apt-get update && apt-get install -y wget curl
      # Install Python dependencies
      pip install --upgrade pip
      pip install -r ml_backend/requirements.txt
      # Download pre-trained models from cloud storage (if available)
      python scripts/download_models.py
    startCommand: |
      cd ml_backend && uvicorn api.main:app --host 0.0.0.0 --port $PORT --workers 2
    envVars:
      - key: MONGODB_URI
        sync: false
      - key: ALPHAVANTAGE_API_KEY
        sync: false
      - key: REDDIT_CLIENT_ID
        sync: false
      - key: REDDIT_CLIENT_SECRET
        sync: false
      - key: REDDIT_USER_AGENT
        sync: false
      - key: FRED_API_KEY
        sync: false
      - key: FINVIZ_API_KEY
        sync: false
      - key: JWT_SECRET_KEY
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_S3_BUCKET_MODELS
        sync: false
      - key: GOOGLE_CLOUD_STORAGE_BUCKET
        sync: false
      - key: PYTHON_VERSION
        value: 3.9.0

  # Node.js Backend API (existing)
  - type: web
    name: stock-predictor-backend
    env: node
    buildCommand: |
      cd backend && npm install
    startCommand: |
      cd backend && npm start
    envVars:
      - key: MONGODB_URI
        sync: false
      - key: REDDIT_CLIENT_ID
        sync: false
      - key: REDDIT_CLIENT_SECRET
        sync: false
      - key: REDDIT_USER_AGENT
        sync: false
      - key: FRED_API_KEY
        sync: false
      - key: JWT_SECRET_KEY
        sync: false

  # Sentiment Pipeline - Every 4 hours
  - type: cron
    name: sentiment-pipeline-cron
    env: python
    schedule: "0 */4 * * *"  # Every 4 hours
    buildCommand: |
      pip install --upgrade pip
      pip install -r ml_backend/requirements.txt
    startCommand: |
      cd ml_backend && python sentiment_cron.py
    envVars:
      - key: MONGODB_URI
        sync: false
      - key: ALPHAVANTAGE_API_KEY
        sync: false
      - key: REDDIT_CLIENT_ID
        sync: false
      - key: REDDIT_CLIENT_SECRET
        sync: false
      - key: REDDIT_USER_AGENT
        sync: false
      - key: FINVIZ_API_KEY
        sync: false
      - key: FRED_API_KEY
        sync: false

  # Model Training & Upload - Weekly
  - type: cron
    name: model-training-cron
    env: python
    schedule: "0 2 * * 0"  # Every Sunday at 2 AM UTC
    buildCommand: |
      pip install --upgrade pip
      pip install -r ml_backend/requirements.txt
    startCommand: |
      cd ml_backend && python scripts/train_and_upload_models.py
    envVars:
      - key: MONGODB_URI
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      - key: AWS_S3_BUCKET_MODELS
        sync: false
      - key: GOOGLE_CLOUD_STORAGE_BUCKET
        sync: false

  # Data Ingestion - Daily
  - type: cron
    name: data-ingestion-cron
    env: python
    schedule: "0 6 * * *"  # Every day at 6 AM UTC
    buildCommand: |
      pip install --upgrade pip
      pip install -r ml_backend/requirements.txt
    startCommand: |
      cd ml_backend && python scripts/daily_data_ingestion.py
    envVars:
      - key: MONGODB_URI
        sync: false
      - key: ALPHAVANTAGE_API_KEY
        sync: false
      - key: FRED_API_KEY
        sync: false 